{"ast":null,"code":"import _defineProperty from \"/home/rcts/Email-differ/Frontend/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport { S3ExpressIdentityCache } from \"./S3ExpressIdentityCache\";\nimport { S3ExpressIdentityCacheEntry } from \"./S3ExpressIdentityCacheEntry\";\nexport class S3ExpressIdentityProviderImpl {\n  constructor(createSessionFn) {\n    let cache = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : new S3ExpressIdentityCache();\n    _defineProperty(this, \"createSessionFn\", void 0);\n    _defineProperty(this, \"cache\", void 0);\n    this.createSessionFn = createSessionFn;\n    this.cache = cache;\n  }\n  async getS3ExpressIdentity(awsIdentity, identityProperties) {\n    const key = identityProperties.Bucket;\n    const {\n      cache\n    } = this;\n    const entry = cache.get(key);\n    if (entry) {\n      return entry.identity.then(identity => {\n        var _identity$expiration$, _identity$expiration, _identity$expiration$2, _identity$expiration2;\n        const isExpired = ((_identity$expiration$ = (_identity$expiration = identity.expiration) === null || _identity$expiration === void 0 ? void 0 : _identity$expiration.getTime()) !== null && _identity$expiration$ !== void 0 ? _identity$expiration$ : 0) < Date.now();\n        if (isExpired) {\n          return cache.set(key, new S3ExpressIdentityCacheEntry(this.getIdentity(key))).identity;\n        }\n        const isExpiringSoon = ((_identity$expiration$2 = (_identity$expiration2 = identity.expiration) === null || _identity$expiration2 === void 0 ? void 0 : _identity$expiration2.getTime()) !== null && _identity$expiration$2 !== void 0 ? _identity$expiration$2 : 0) < Date.now() + S3ExpressIdentityProviderImpl.REFRESH_WINDOW_MS;\n        if (isExpiringSoon && !entry.isRefreshing) {\n          entry.isRefreshing = true;\n          this.getIdentity(key).then(id => {\n            cache.set(key, new S3ExpressIdentityCacheEntry(Promise.resolve(id)));\n          });\n        }\n        return identity;\n      });\n    }\n    return cache.set(key, new S3ExpressIdentityCacheEntry(this.getIdentity(key))).identity;\n  }\n  async getIdentity(key) {\n    var _session$Credentials, _session$Credentials2;\n    await this.cache.purgeExpired().catch(error => {\n      console.warn(\"Error while clearing expired entries in S3ExpressIdentityCache: \\n\" + error);\n    });\n    const session = await this.createSessionFn(key);\n    if (!((_session$Credentials = session.Credentials) !== null && _session$Credentials !== void 0 && _session$Credentials.AccessKeyId) || !((_session$Credentials2 = session.Credentials) !== null && _session$Credentials2 !== void 0 && _session$Credentials2.SecretAccessKey)) {\n      throw new Error(\"s3#createSession response credential missing AccessKeyId or SecretAccessKey.\");\n    }\n    const identity = {\n      accessKeyId: session.Credentials.AccessKeyId,\n      secretAccessKey: session.Credentials.SecretAccessKey,\n      sessionToken: session.Credentials.SessionToken,\n      expiration: session.Credentials.Expiration ? new Date(session.Credentials.Expiration) : undefined\n    };\n    return identity;\n  }\n}\n_defineProperty(S3ExpressIdentityProviderImpl, \"REFRESH_WINDOW_MS\", 60000);","map":{"version":3,"names":["S3ExpressIdentityCache","S3ExpressIdentityCacheEntry","S3ExpressIdentityProviderImpl","constructor","createSessionFn","cache","arguments","length","undefined","_defineProperty","getS3ExpressIdentity","awsIdentity","identityProperties","key","Bucket","entry","get","identity","then","_identity$expiration$","_identity$expiration","_identity$expiration$2","_identity$expiration2","isExpired","expiration","getTime","Date","now","set","getIdentity","isExpiringSoon","REFRESH_WINDOW_MS","isRefreshing","id","Promise","resolve","_session$Credentials","_session$Credentials2","purgeExpired","catch","error","console","warn","session","Credentials","AccessKeyId","SecretAccessKey","Error","accessKeyId","secretAccessKey","sessionToken","SessionToken","Expiration"],"sources":["/home/rcts/Email-differ/Frontend/node_modules/@aws-sdk/middleware-sdk-s3/dist-es/s3-express/classes/S3ExpressIdentityProviderImpl.js"],"sourcesContent":["import { S3ExpressIdentityCache } from \"./S3ExpressIdentityCache\";\nimport { S3ExpressIdentityCacheEntry } from \"./S3ExpressIdentityCacheEntry\";\nexport class S3ExpressIdentityProviderImpl {\n    createSessionFn;\n    cache;\n    static REFRESH_WINDOW_MS = 60_000;\n    constructor(createSessionFn, cache = new S3ExpressIdentityCache()) {\n        this.createSessionFn = createSessionFn;\n        this.cache = cache;\n    }\n    async getS3ExpressIdentity(awsIdentity, identityProperties) {\n        const key = identityProperties.Bucket;\n        const { cache } = this;\n        const entry = cache.get(key);\n        if (entry) {\n            return entry.identity.then((identity) => {\n                const isExpired = (identity.expiration?.getTime() ?? 0) < Date.now();\n                if (isExpired) {\n                    return cache.set(key, new S3ExpressIdentityCacheEntry(this.getIdentity(key))).identity;\n                }\n                const isExpiringSoon = (identity.expiration?.getTime() ?? 0) < Date.now() + S3ExpressIdentityProviderImpl.REFRESH_WINDOW_MS;\n                if (isExpiringSoon && !entry.isRefreshing) {\n                    entry.isRefreshing = true;\n                    this.getIdentity(key).then((id) => {\n                        cache.set(key, new S3ExpressIdentityCacheEntry(Promise.resolve(id)));\n                    });\n                }\n                return identity;\n            });\n        }\n        return cache.set(key, new S3ExpressIdentityCacheEntry(this.getIdentity(key))).identity;\n    }\n    async getIdentity(key) {\n        await this.cache.purgeExpired().catch((error) => {\n            console.warn(\"Error while clearing expired entries in S3ExpressIdentityCache: \\n\" + error);\n        });\n        const session = await this.createSessionFn(key);\n        if (!session.Credentials?.AccessKeyId || !session.Credentials?.SecretAccessKey) {\n            throw new Error(\"s3#createSession response credential missing AccessKeyId or SecretAccessKey.\");\n        }\n        const identity = {\n            accessKeyId: session.Credentials.AccessKeyId,\n            secretAccessKey: session.Credentials.SecretAccessKey,\n            sessionToken: session.Credentials.SessionToken,\n            expiration: session.Credentials.Expiration ? new Date(session.Credentials.Expiration) : undefined,\n        };\n        return identity;\n    }\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}
{"ast":null,"code":"import{useEffect,useRef}from\"react\";import axios from\"axios\";import{useSearchParams,useNavigate}from\"react-router-dom\";export default function DiscordCallback(){const[searchParams]=useSearchParams();const navigate=useNavigate();const code=searchParams.get(\"code\");const error=searchParams.get(\"error\");const state=searchParams.get(\"state\");// ✅ Get state parameter\nconst hasProcessed=useRef(false);useEffect(()=>{// Prevent duplicate execution in React Strict Mode\nif(hasProcessed.current){return;}// Mark as processing immediately to prevent duplicate calls\nhasProcessed.current=true;// Helper: Always preserve form data on Discord redirects\nconst preserveState=()=>{sessionStorage.setItem(\"activeStep\",\"2\");sessionStorage.setItem(\"isNavigating\",\"true\");sessionStorage.setItem(\"cameFromDiscord\",\"true\");};// Determine return path (signup or update-form)\nconst getReturnPath=()=>{const savedPath=sessionStorage.getItem(\"oauthReturnPath\");return savedPath||\"/signup\";};// User cancelled Discord authorization\nif(error===\"access_denied\"){preserveState();sessionStorage.setItem(\"discord_cancelled\",\"true\");// ✅ Clear stale member flag on cancel\nsessionStorage.removeItem(\"discordNotMember\");navigate(getReturnPath(),{replace:true});return;}// No code received → go back safely\nif(!code){preserveState();navigate(getReturnPath(),{replace:true});return;}// ✅ Verify OAuth state to prevent CSRF\nconst savedState=sessionStorage.getItem(\"discordOAuthState\");if(savedState&&state!==savedState){console.error(\"OAuth state mismatch - possible CSRF attack\");sessionStorage.setItem(\"discord_error\",\"Security validation failed. Please try again.\");preserveState();navigate(getReturnPath(),{replace:true});return;}// ✅ Clear used state\nsessionStorage.removeItem(\"discordOAuthState\");// SUCCESS PATH\nconst verify=async()=>{try{const res=await axios.post(\"http://localhost:8000/api/discord/callback\",{code});const{discordId,username,discriminator,avatar,avatarUrl,isMember}=res.data;sessionStorage.setItem(\"discord_verification_loading\",\"true\");if(discordId)sessionStorage.setItem(\"discordId\",discordId);if(username&&discriminator)sessionStorage.setItem(\"discordUsername\",\"\".concat(username,\"#\").concat(discriminator));sessionStorage.setItem(\"discordAvatar\",avatar||\"\");sessionStorage.setItem(\"discordAvatarUrl\",avatarUrl||\"\");if(isMember){sessionStorage.setItem(\"discordVerified\",\"true\");sessionStorage.removeItem(\"discordNotMember\");}else{sessionStorage.setItem(\"discordNotMember\",\"true\");sessionStorage.removeItem(\"discordVerified\");}preserveState();navigate(getReturnPath());}catch(err){var _err$response,_err$response2,_err$response2$data,_err$response3,_err$response4,_err$response4$data;console.error(\"Discord OAuth error:\",((_err$response=err.response)===null||_err$response===void 0?void 0:_err$response.data)||err.message);// ✅ Clear stale member flag on error\nsessionStorage.removeItem(\"discordNotMember\");sessionStorage.removeItem(\"discordVerified\");// Store user-friendly error info\nif(((_err$response2=err.response)===null||_err$response2===void 0?void 0:(_err$response2$data=_err$response2.data)===null||_err$response2$data===void 0?void 0:_err$response2$data.error)===\"invalid_grant\"){sessionStorage.setItem(\"discord_error\",\"Code expired or already used. Please try again.\");}else if(((_err$response3=err.response)===null||_err$response3===void 0?void 0:_err$response3.status)===429){sessionStorage.setItem(\"discord_error\",\"Too many attempts. Please wait a moment.\");}else if((_err$response4=err.response)!==null&&_err$response4!==void 0&&(_err$response4$data=_err$response4.data)!==null&&_err$response4$data!==void 0&&_err$response4$data.message){// Show backend error message if available\nsessionStorage.setItem(\"discord_error\",err.response.data.message);}else{sessionStorage.setItem(\"discord_error\",\"Verification failed. Please try again.\");}sessionStorage.setItem(\"discord_verification_loading\",\"true\");preserveState();navigate(getReturnPath());}};verify();},[code,error,state,navigate]);return null;}","map":{"version":3,"names":["useEffect","useRef","axios","useSearchParams","useNavigate","DiscordCallback","searchParams","navigate","code","get","error","state","hasProcessed","current","preserveState","sessionStorage","setItem","getReturnPath","savedPath","getItem","removeItem","replace","savedState","console","verify","res","post","discordId","username","discriminator","avatar","avatarUrl","isMember","data","concat","err","_err$response","_err$response2","_err$response2$data","_err$response3","_err$response4","_err$response4$data","response","message","status"],"sources":["/home/rcts/Email-differ/Frontend/src/pages/Signin-otp/DiscordCallback.js"],"sourcesContent":["import { useEffect, useRef } from \"react\";\nimport axios from \"axios\";\nimport { useSearchParams, useNavigate } from \"react-router-dom\";\n\nexport default function DiscordCallback() {\n  const [searchParams] = useSearchParams();\n  const navigate = useNavigate();\n  const code = searchParams.get(\"code\");\n  const error = searchParams.get(\"error\");\n  const state = searchParams.get(\"state\"); // ✅ Get state parameter\n  const hasProcessed = useRef(false);\n\n  useEffect(() => {\n    // Prevent duplicate execution in React Strict Mode\n    if (hasProcessed.current) {\n      return;\n    }\n\n    // Mark as processing immediately to prevent duplicate calls\n    hasProcessed.current = true;\n\n    // Helper: Always preserve form data on Discord redirects\n    const preserveState = () => {\n      sessionStorage.setItem(\"activeStep\", \"2\");\n      sessionStorage.setItem(\"isNavigating\", \"true\");\n      sessionStorage.setItem(\"cameFromDiscord\", \"true\");\n    };\n\n    // Determine return path (signup or update-form)\n    const getReturnPath = () => {\n      const savedPath = sessionStorage.getItem(\"oauthReturnPath\");\n      return savedPath || \"/signup\";\n    };\n\n    // User cancelled Discord authorization\n    if (error === \"access_denied\") {\n      preserveState();\n      sessionStorage.setItem(\"discord_cancelled\", \"true\");\n      // ✅ Clear stale member flag on cancel\n      sessionStorage.removeItem(\"discordNotMember\");\n      navigate(getReturnPath(), { replace: true });\n      return;\n    }\n\n    // No code received → go back safely\n    if (!code) {\n      preserveState();\n      navigate(getReturnPath(), { replace: true });\n      return;\n    }\n\n    // ✅ Verify OAuth state to prevent CSRF\n    const savedState = sessionStorage.getItem(\"discordOAuthState\");\n    if (savedState && state !== savedState) {\n      console.error(\"OAuth state mismatch - possible CSRF attack\");\n      sessionStorage.setItem(\"discord_error\", \"Security validation failed. Please try again.\");\n      preserveState();\n      navigate(getReturnPath(), { replace: true });\n      return;\n    }\n    \n    // ✅ Clear used state\n    sessionStorage.removeItem(\"discordOAuthState\");\n\n    // SUCCESS PATH\n    const verify = async () => {\n      \n      try {\n        const res = await axios.post(\n          \"http://localhost:8000/api/discord/callback\",\n          { code }\n        );\n\n        const {\n          discordId,\n          username,\n          discriminator,\n          avatar,\n          avatarUrl,\n          isMember,\n        } = res.data;\n\n        sessionStorage.setItem(\"discord_verification_loading\", \"true\");\n\n        if (discordId) sessionStorage.setItem(\"discordId\", discordId);\n\n        if (username && discriminator)\n          sessionStorage.setItem(\n            \"discordUsername\",\n            `${username}#${discriminator}`\n          );\n\n        sessionStorage.setItem(\"discordAvatar\", avatar || \"\");\n        sessionStorage.setItem(\"discordAvatarUrl\", avatarUrl || \"\");\n\n        if (isMember) {\n          sessionStorage.setItem(\"discordVerified\", \"true\");\n          sessionStorage.removeItem(\"discordNotMember\");\n        } else {\n          sessionStorage.setItem(\"discordNotMember\", \"true\");\n          sessionStorage.removeItem(\"discordVerified\");\n        }\n\n        preserveState();\n        navigate(getReturnPath());\n\n      } catch (err) {\n        console.error(\"Discord OAuth error:\", err.response?.data || err.message);\n\n        // ✅ Clear stale member flag on error\n        sessionStorage.removeItem(\"discordNotMember\");\n        sessionStorage.removeItem(\"discordVerified\");\n        \n        // Store user-friendly error info\n        if (err.response?.data?.error === \"invalid_grant\") {\n          sessionStorage.setItem(\"discord_error\", \"Code expired or already used. Please try again.\");\n        } else if (err.response?.status === 429) {\n          sessionStorage.setItem(\"discord_error\", \"Too many attempts. Please wait a moment.\");\n        } else if (err.response?.data?.message) {\n          // Show backend error message if available\n          sessionStorage.setItem(\"discord_error\", err.response.data.message);\n        } else {\n          sessionStorage.setItem(\"discord_error\", \"Verification failed. Please try again.\");\n        }\n\n        sessionStorage.setItem(\"discord_verification_loading\", \"true\");\n        preserveState();\n        navigate(getReturnPath());\n      }\n    };\n\n    verify();\n\n  }, [code, error, state, navigate]);\n\n  return null;\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}